# How To

> **Available languages**: [English (current)](HOWTO.md) | [Italiano](HOWTO.it.md)

## Guide for Using Configuration Files

You can use these configuration files in two ways:

- **Build after installation**
- **Direct installation** of NixOS using your custom configuration files

Let's explore both methods.

---

## Build After Installation

You can perform a graphical installation first and, after the initial boot, rebuild your system using your configuration files.

Summarizing, you should:

1. **Install NixOS** normally.
2. **Modify** the configuration files as desired.
3. **Build** those files on your NixOS host.

### Installing NixOS

Download the desired ISO (either Gnome or KDE-Plasma) from the [official NixOS project page](https://nixos.org/download/) under the “NixOS: the Linux distribution” section. Boot this ISO on your host machine.

During installation:

- **Disk Partitioning**  
  After installation, a configuration file will be generated at `/etc/nixos/configuration.nix`. Inside it, you'll find a line specifying the GRUB device, for example:

  ```nix
  boot.loader.grub.device = "/dev/disk/by-id/wwn-0x500001234567890a";
  ```
  
  **Save** this value (`/dev/disk/by-id/...`) for later, as you'll need it in your custom configuration.

- **User**  
  Choose the same username that you plan to use in your configuration files, or copy an existing user configuration generated by the installer.

> **Important:** these settings will be overwritten by your custom configuration after the first build, so pay close attention to disk partitioning and user naming.

### Modifying Configuration Files

You can use these files in two ways:

> **Notice:** before editing any configuration files, **read the `env.conf` file**.
> It contains environment variables and references to the files where they are used.
> Feel free to modify `env.conf` according to your needs, whether you're copying files manually or using the provided script.

1. **Manual Copy**
   - Copy the `nixos_configs_template` folder.
   - Remove the `template` suffix from each file extension (change `.nix.template` to `.nix`).
   - Replace variables listed in `env.conf` with your specific setup values.

2. **Using the Script**
   - Execute the `nixos_configs_generator.sh` script (see the [nixos_configurations_generator repository](https://github.com/palumbou/nixos_configurations_generator)) to automate the above steps.

### Building

When you're ready to **build** your configuration, run:

```bash
nixos-rebuild switch -I nixos-config=PATH_NIXOS_CONF_FOLDER/configuration.nix
```

Replace `PATH_NIXOS_CONF_FOLDER` with the absolute or relative path to your `configuration.nix`.

> **Tip:** To get more details during the build process, add the `--show-trace` option:
> ```bash
> nixos-rebuild switch -I nixos-config=./configuration.nix --show-trace
> ```

---

## Direct Installation

Using the Disko module, you can directly install NixOS starting from disk formatting.

Refer to the [Disko README](./nixos_configs_template/hosts/disk_configurations/README.md) [Usage section](./nixos_configs_template/hosts/disk_configurations/README.md#usage) for initial setup details. Here, we'll focus on using your customized files generated from the "nixos_configs" folder.

Following the instructions in the [Modifying Configuration Files](#modifying-configuration-files) section above, customize and save your own copy to a USB drive, network share, private Git repository, or other storage.

Pay special attention to paths for the files you will copy, particularly Network Manager configurations (`nm_configurations.nix` within each defined host folder) and user dotfiles (within the `users` folder). The relevant variables are `BASEPATHNM` and `BASEPATHUSER`, both defined as `/home` in the `env.conf` file.

### Why `/home`?

For security, the "nixos_config" folder should be under `/home` with root ownership, ensuring only administrators can modify or use these files (since rebuilding requires admin privileges). During installation, after formatting the disk, it will be mounted at `/mnt`. You can then create a `/home` directory if not already partitioned and copy the "nixos_config" folder there, preserving it post-installation.

### Installation Steps

Assuming you have the modified and personalized "nixos_config" folder ready:

1. **Boot the official installer ISO** downloaded from [official NixOS project page](https://nixos.org/download/) on your machine.

2. Copy the "nixos_config" folder to `/home/nixos`:
   ```bash
   /home/nixos/nixos_config
   ```

3. Format the disk with your chosen template, found in your host folder:
   ```bash
   sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode destroy,format,mount /home/nixos/nixos_config/hosts/ABC/single-disk-ext4-bios.nix
   ```

4. After successful formatting, the disk will be mounted at `/mnt`. Create `/home` and copy your config:
   ```bash
   sudo mkdir -p /mnt/home && sudo cp -r /home/nixos/nixos_config /mnt/home/
   ```

5. *(Optional)* Generate `hardware-configuration.nix` if needed and copy it to your host folder:
   ```bash
   sudo nixos-generate-config --no-filesystems --root /mnt && sudo cp /mnt/etc/nixos/hardware-configuration.nix /mnt/home/nixos_config/hosts/ABC/
   ```

6. Proceed with installation:
   ```bash
   sudo NIXOS_CONFIG=/mnt/home/nixos_config/hosts/ABC/configuration.nix nixos-install
   ```

7. Reboot the system:
   ```bash
   reboot
   ```

If all commands executed correctly, upon reboot you'll have a fully configured environment.